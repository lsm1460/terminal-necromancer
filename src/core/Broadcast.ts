import fs from 'fs'
import path from 'path'
import { EventSystem } from '../systems/EventSystem'
import { BroadcastScript } from '../types'
import { NPCManager } from './NpcManager'

export class Broadcast {
  private scripts: Record<string, BroadcastScript>
  private pendingQueue: string[] = []
  private playProgress: Record<string, number> = {}
  private playedState: Record<string, boolean> = {}

  private justFinishedEvent = false

  private bridgeMemos = [
    'ğŸ“¢ ì´ì „ ë³´ê³ ì— ì´ì–´ ì¶”ê°€ ì•Œë¦¼ì…ë‹ˆë‹¤...',
    'ğŸ“¢ ë‹¤ìŒ ì†Œì‹ì…ë‹ˆë‹¤...',
    'ğŸ“¢ ì¹˜ì´ìµ... ê¸´ê¸‰ ê°±ì‹ ëœ ì •ë³´ì…ë‹ˆë‹¤.',
    'ğŸ“¢ ë°©ê¸ˆ ë“¤ì–´ì˜¨ ì¶”ê°€ ì œë³´ë¥¼ ì „í•´ë“œë¦½ë‹ˆë‹¤.',
  ]

  private terminalMessages = [
    // ì‹œì„¤ ê´€ë¦¬ ë° ê³µì§€
    'ğŸ“¢ "ì•Œë¦½ë‹ˆë‹¤. ì œ3êµ¬ì—­ ëƒ‰ê°ìˆ˜ ìœ ì¶œì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì¸ê·¼ ì¸ë¶€ë“¤ì€ ì¦‰ì‹œ ëŒ€í”¼í•˜ì‹­ì‹œì˜¤."',
    'ğŸ“¢ "ê³µì§€: ê¸ˆì¼ í•˜ì—­ ìŠ¤ì¼€ì¤„ì´ ì§€ì—°ë¨ì— ë”°ë¼ ë°°ê¸‰ëŸ‰ì´ 15% ì‚­ê°ë©ë‹ˆë‹¤."',
    'ğŸ“¢ "ì¹˜ìµ... í˜„ì¬ ì§€í•˜ 3ì¸µ ì‚°ì†Œ ë†ë„ 88%. ì •ìƒ ë²”ì£¼ì…ë‹ˆë‹¤. ë…¸ì—­ì„ ì§€ì†í•˜ì‹­ì‹œì˜¤."',

    // ê²½ê³  ë° ë³´ì•ˆ
    'ğŸ“¢ "ê²½ê³ . ì¸ê°€ë˜ì§€ ì•Šì€ ì˜ë ¹ ì—ë„ˆì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ë³´ì•ˆ ë“±ê¸‰ì„ ìƒí–¥í•©ë‹ˆë‹¤."',
    'ğŸ“¢ "ì•Œë¦½ë‹ˆë‹¤. ìµœê·¼ ì ë°œëœ ë‚´ë¶€ ì²©ìëŠ” í•˜ì—­ì¥ ì••ì°©ê¸°ì—ì„œ ì¦‰ê° ì²˜í˜•ë˜ì—ˆìŠµë‹ˆë‹¤."',
    'ğŸ“¢ "ë³´ì•ˆ ìˆ˜ì¹™ ì¤€ìˆ˜: í—ˆê°€ë˜ì§€ ì•Šì€ ì‹œì²´ ì ìœ ëŠ” ì—„ê²©íˆ ê¸ˆì§€ë˜ì–´ ìˆìŠµë‹ˆë‹¤."',

    // ì„¸ê³„ê´€ ì„ ì „ (Propaganda)
    'ğŸ“¢ "ìœ„ëŒ€í•œ ê°•ì² ì˜ ì‹œëŒ€. ìœ¡ì‹ ì€ ì©ìœ¼ë‚˜ ê¸°ê³„ëŠ” ì˜ì›í•©ë‹ˆë‹¤."',
    'ğŸ“¢ "ì‚¬ë ¹ìˆ ì€ ì§ˆë³‘ì…ë‹ˆë‹¤. ì´ìƒ ì¦ì„¸ë¥¼ ë³´ì´ëŠ” ë™ë£ŒëŠ” ì¦‰ì‹œ ê´€ë¦¬êµ­ì— ì‹ ê³ í•˜ì‹­ì‹œì˜¤."',
    'ğŸ“¢ "ì˜¤ëŠ˜ì˜ êµ¬í˜¸: ë” ë†’ì€ ì ì¬, ë” ë¹ ë¥¸ ê³µì •, ë” ì™„ë²½í•œ í†µì œ."',

    // ì‚¬ë¬´ì ì´ê³  ë¬´ì‹¬í•œ ë³´ê³ 
    "ğŸ“¢ \"ë¯¸ìˆ˜ìŠµ ì‚¬ì²´ 47êµ¬ í™•ì¸. íê¸° ê³µì •ìœ¼ë¡œ ì´ì†¡ì„ ì‹œì‘í•©ë‹ˆë‹¤.\"",
    "ğŸ“¢ \"ì¹˜ìµ... ê¸ˆì¼ ì‚¬ë§í•œ ì¸ë¶€ë“¤ì˜ ìœ í’ˆì€ ì •ì˜¤ì— ì¼ê´„ ì†Œê°ë©ë‹ˆë‹¤.\"",
    "ğŸ“¢ \"í•˜ì—­ íš¨ìœ¨ 4% ê°ì†Œ. ì›ì¸ì€ ì¸ì  ìì›ì˜ ë…¸í›„í™”ë¡œ íŒë‹¨ë©ë‹ˆë‹¤.\"",
    
    // ë¹„ì •í•œ í†µì œ
    "ğŸ“¢ \"ì•Œë¦½ë‹ˆë‹¤. ë¹„ëª…ì€ ì†ŒìŒ ê³µí•´ì…ë‹ˆë‹¤. ì •ìˆ™ì„ ìœ ì§€í•˜ì‹­ì‹œì˜¤.\"",
    "ğŸ“¢ \"íƒˆì¶œ ì‹œë„ëŠ” ììœ ì´ë‚˜, ì‚¬ì‚´ í›„ ì¬í™œìš© ê¶Œí•œì€ ê´€ë¦¬êµ­ì— ìˆìŠµë‹ˆë‹¤.\"",
    "ğŸ“¢ \"ë³´ì•ˆíŒ€ ê³µì§€: ì¹¨ì…ì ë°œê²¬ ì‹œ ìƒí¬í•˜ì§€ ë§ˆì‹­ì‹œì˜¤. íƒ„ì•½ì´ ì•„ê¹ìŠµë‹ˆë‹¤.\"",

    // ê±´ì¡°í•œ ì„¸ê³„ê´€ ë¬˜ì‚¬
    "ğŸ“¢ \"ê¸°ê³„ëŠ” ê±°ì§“ë§ì„ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¹ì‹ ì˜ ê·¼ìœ¡ë³´ë‹¤ ì—”ì§„ì„ ë¯¿ìœ¼ì‹­ì‹œì˜¤.\"",
    "ğŸ“¢ \"ì‚¬ë ¹ìˆ ì‚¬ í¬ì°©. ìƒì²´ ë°˜ì‘ ì •ì§€ í›„ ë‹¤ì‹œ ë³´ê³ í•  ì˜ˆì •ì…ë‹ˆë‹¤. ì´ìƒ.\"",
    "ğŸ“¢ \"í•˜ì—­ì¥ì€ ë‹¹ì‹ ì˜ ê°ì •ì— ê´€ì‹¬ì´ ì—†ìŠµë‹ˆë‹¤. ìƒìë¥¼ ì˜®ê¸°ì‹­ì‹œì˜¤.\"",
    "ğŸ“¢ \"ì¹˜ì§... ëˆ„ì¶œëœ ëƒ‰ê°ìˆ˜ëŠ” ì¸ì²´ì˜ 70%ë¥¼ ì¦‰ì‹œ ë™ê²°ì‹œí‚µë‹ˆë‹¤. ì°¸ê³ í•˜ì‹­ì‹œì˜¤.\"",

    // ë¯¸ì•„/ìì‚° ë¶„ì‹¤ ê´€ë ¨ (ê¸°ê´´í•˜ê³  ì‹œí¬í•¨)
    "ğŸ“¢ \"ì•Œë¦½ë‹ˆë‹¤. ì œ2í•˜ì—­ì¥ì—ì„œ ì†Œí˜• ì¸ì  ìì›(ë¯¸ì•„)ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì†Œìœ ì£¼ëŠ” íê¸° ì „ ìˆ˜ê±°í•˜ì‹­ì‹œì˜¤.\"",
    "ğŸ“¢ \"ê³µì§€: ìœ ì‹¤ëœ ì•„ë™ì„ ë³´ê´€ ì¤‘ì…ë‹ˆë‹¤. 6ì‹œê°„ ë‚´ ë¯¸ìˆ˜ê±° ì‹œ í•˜ì—­ì¥ ìë™ ì²­ì†Œ ì‹œìŠ¤í…œì— íˆ¬ì…ë©ë‹ˆë‹¤.\"",
    "ğŸ“¢ \"ì¹˜ìµ... ë¶„ì‹¤ëœ ì•„ì´ë¥¼ ì°¾ëŠ” ë¶€ëª¨ì—ê²Œ ì•Œë¦½ë‹ˆë‹¤. ê°ì •ì  ë™ìš”ëŠ” ì‘ì—… íš¨ìœ¨ì„ ì €í•´í•©ë‹ˆë‹¤. ì¦‰ì‹œ ë³µê·€í•˜ì‹­ì‹œì˜¤.\"",
    "ğŸ“¢ \"ì•Œë¦½ë‹ˆë‹¤. ì¸ì§€ ëŠ¥ë ¥ì´ ë¯¸ì„±ìˆ™í•œ ê°œì²´ê°€ ê¶¤ë„ë¥¼ ì´íƒˆí–ˆìŠµë‹ˆë‹¤. ë°œê²¬ ì‹œ ê°€ê¹Œìš´ ìˆ˜ê±°í•¨ì— ë„£ì–´ì£¼ì‹­ì‹œì˜¤.\"",

      // ë¬´ì‹¬í•œ ì¼ìƒ ë³´ê³ 
    "ğŸ“¢ \"ì˜¤ëŠ˜ì˜ ë¶„ì‹¤ë¬¼: ì˜ìˆ˜ 1ê°œ, ë‚¡ì€ ì¸í˜•, ì‹ ì› ë¯¸ìƒì˜ ì†ê°€ë½. ì£¼ì¸ì„ ì°¾ì§€ ì•ŠìŠµë‹ˆë‹¤. ì†Œê° ì˜ˆì •ì…ë‹ˆë‹¤.\"",
    "ğŸ“¢ \"ì¹˜ì§... í•˜ì—­ì¥ ë‚´ì—ì„œ ìš¸ìŒì†Œë¦¬ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ë³´ì•ˆíŒ€ì€ ì†ŒìŒ ë°œìƒì›ì„ ì¦‰ê° ì œê±°í•˜ì‹­ì‹œì˜¤.\"",
    "ğŸ“¢ \"ê³µì§€: ìì‚° ë³´í˜¸ë¥¼ ìœ„í•´ ì•„ë™ì˜ ë°œëª©ì— ì¸ì‹í‘œë¥¼ ë¶€ì°©í•˜ì‹­ì‹œì˜¤. ë¯¸ë¶€ì°© ê°œì²´ëŠ” ìœ ê¸°ë¬¼ë¡œ ë¶„ë¥˜ë©ë‹ˆë‹¤.\"",

    // ëƒ‰ì†Œì ì¸ í†µì œ
    "ğŸ“¢ \"ì•Œë¦½ë‹ˆë‹¤. ê°€ì¡±ì„ ì°¾ëŠ” í–‰ìœ„ëŠ” ì¸ê°€ë˜ì§€ ì•Šì€ ê°œì¸ í™œë™ì…ë‹ˆë‹¤. í• ë‹¹ëŸ‰ì„ ì±„ìš´ ë’¤ ì‚¬ìœ í•˜ì‹­ì‹œì˜¤.\"",
    "ğŸ“¢ \"ì¹˜ìµ... ë¶„ì‹¤ëœ ê°œì²´ 'ì—ì´ë¯¸(7ì„¸)'ì˜ ì¸ì‹í‘œê°€ íŒŒì†ëœ ì±„ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ê·¸ëƒ¥ ê·¸ë ‡ë‹¤ê³ ìš”.\"",
  ]

  constructor(
    scriptPath: string,
    private npcManager: NPCManager,
    eventSystem: EventSystem
  ) {
    this.scripts = JSON.parse(fs.readFileSync(path.resolve(scriptPath), 'utf-8'))

    eventSystem.subscribe((eventId) => this.onEventCleared(eventId))
  }

  private onEventCleared(eventId: string) {
    if (this.scripts[eventId] && !this.playedState[eventId]) {
      this.pendingQueue.push(eventId)
    }
  }

  async play() {
    // 0. ëŒ€ê¸°ì—´ì´ ì—†ìœ¼ë©´ ëœë¤ ë©˜íŠ¸ ë°œì†¡
    if (this.pendingQueue.length === 0) {
      const BROADCAST_CHANCE = 0.15

      if (Math.random() < BROADCAST_CHANCE) {
        const randomIndex = Math.floor(Math.random() * this.terminalMessages.length)
        const message = this.terminalMessages[randomIndex]

        console.log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
        console.log(`ğŸ“¡ [í„°ë¯¸ë„ ë¸Œë¡œë“œìºìŠ¤íŒ…: ì—ì½”]`)
        console.log(`  ${message}`)
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
      }

      return
    }

    const currentEventId = this.pendingQueue[0]
    const content = this.scripts[currentEventId]
    const currentIndex = this.playProgress[currentEventId] || 0

    // 2. í—¤ë” ì¶œë ¥
    console.log(`\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`)
    console.log(`ğŸ“¡ [í„°ë¯¸ë„ ë¸Œë¡œë“œìºìŠ¤íŒ…: ì—ì½”]`)

    // 3. ë¸Œë¦¿ì§€ ë©˜íŠ¸ ì¶œë ¥ ì¡°ê±´ (ìƒˆ ì´ë²¤íŠ¸ ì‹œì‘ + ì´ì „ ì´ë²¤íŠ¸ê°€ ë°©ê¸ˆ ëë‚¬ì„ ë•Œ)
    if (currentIndex === 0 && this.justFinishedEvent) {
      const randomBridge = this.bridgeMemos[Math.floor(Math.random() * this.bridgeMemos.length)]
      console.log(`  ${randomBridge}`)

      // ë¸Œë¦¿ì§€ë¥¼ í•œ ë²ˆ ì¶œë ¥í–ˆìœ¼ë¯€ë¡œ í”Œë˜ê·¸ ì´ˆê¸°í™”
      this.justFinishedEvent = false
    }

    // 4. ë©”ì¸ ëŒ€ì‚¬ ì¶œë ¥ (printNextLine ë¡œì§ í†µí•©)
    const isHostile = this.npcManager.getFactionContribution('resistance') >= 70
    const lines = isHostile ? content.hostile : content.normal

    if (currentIndex < lines.length) {
      console.log(`  ğŸ“¢ "${lines[currentIndex]}"`)

      // ì§„í–‰ë„ ì—…ë°ì´íŠ¸
      this.playProgress[currentEventId] = currentIndex + 1

      // í•´ë‹¹ ì´ë²¤íŠ¸ì˜ ëª¨ë“  ì¤„ì„ ë‹¤ ì½ì—ˆëŠ”ì§€ í™•ì¸
      if (this.playProgress[currentEventId] >= lines.length) {
        this.playedState[currentEventId] = true
      }
    }

    console.log(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`)

    // 5. ì´ë²¤íŠ¸ê°€ ì™„ì „íˆ ì¢…ë£Œë˜ì—ˆë‹¤ë©´ íì—ì„œ ì œê±°í•˜ê³  í”Œë˜ê·¸ ì„¸ìš°ê¸°
    if (this.playedState[currentEventId]) {
      this.pendingQueue.shift()
      this.justFinishedEvent = true // ë‹¤ìŒ play() í˜¸ì¶œ ì‹œ ë¸Œë¦¿ì§€ ì¶œë ¥ ëŒ€ìƒì´ ë¨
    }
  }
}
